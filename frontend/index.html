<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Prototype-X</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#02040a; --bg2:#000;
  --panel:#0a0a0a; --panel-2:#1a1a1a; --line:#333;
  --accent:#007aff; --accent-2:#005fcc;
  --green:#34c759; --green-2:#28a745;
  --danger:#ff4040; --red-edge:#6b1a1a;
  --barH: 88px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:'Inter',sans-serif;min-height:100%;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:#fff;overflow:auto;}
header{position:sticky; top:0; z-index:200; display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;background:var(--panel);border-bottom:1px solid var(--line)}
.left{display:flex;align-items:center;gap:10px}
.menu-btn{background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer}
header img{width:30px;height:30px}
h1{font-size:1.1rem}
.actions{display:flex;gap:8px}
.icon-btn{border:none;border-radius:50%;width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
  color:#fff;font-size:1rem;cursor:pointer;display:grid;place-items:center;transition:.25s;box-shadow:0 0 10px rgba(0,122,255,.35);}
.icon-btn:hover{transform:scale(1.05)}
.sidebar{position:fixed;top:0;left:-340px;width:330px;height:100%;background:var(--panel);border-right:1px solid var(--line);
  transition:left .28s ease;z-index:300;display:flex;flex-direction:column;}
.sidebar.active{left:0}
.sb-top{position:sticky; top:0; z-index:1; display:flex;align-items:center;justify-content:space-between; gap:8px; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line);}
.sb-title{display:flex;align-items:center;gap:8px;font-weight:600}
.close-btn{background:none;border:none;color:#fff;font-size:1.25rem;cursor:pointer;line-height:1}
.sb-body{padding:14px 14px 110px; overflow:auto;}
.group{margin:12px 0}
.label{font-size:.88rem;margin-bottom:6px;opacity:.9}
.select{width:100%;padding:10px 12px;border-radius:10px;background:#0f0f0f;color:#fff;border:1px solid var(--red-edge);font-size:.92rem}
.check{display:flex;align-items:center;gap:8px;margin:8px 0}
.check input{appearance:none;width:18px;height:18px;border-radius:5px;border:2px solid var(--danger);cursor:pointer;position:relative}
.check input:checked{background:var(--danger)}
.check input:checked::after{content:"‚úì";position:absolute;color:#fff;font-size:12px;left:3px;top:-1px}
.slider-row{display:flex;align-items:center;gap:8px}
input[type="range"]{-webkit-appearance:none;width:100%;height:4px;background:#2a2a2a;border-radius:3px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--danger);border:2px solid #f7b1ad;cursor:pointer}
.badge{font-size:.8rem;background:#0f0f0f;border:1px solid var(--red-edge);padding:6px 8px;border-radius:8px;display:inline-block}
.hint{font-size:.78rem;opacity:.7;margin-top:6px;display:block}
.credits{margin-top:16px;padding-top:10px;border-top:1px dashed var(--line);font-size:.8rem;opacity:.75;text-align:center;line-height:1.35}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:250;display:none}
.backdrop.show{display:block}
.main{display:flex;flex-direction:column}
.chat-container{padding:30px 16px calc(var(--barH) + 24px); display:flex;flex-direction:column;gap:12px;
  scrollbar-width:thin; scrollbar-color:#4c8dff1a transparent;}
.chat-container::-webkit-scrollbar{width:10px}
.chat-container::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#4c8dff,#2a5fd1); border-radius:8px; border:2px solid transparent; background-clip:padding-box;}
.chat-bubble{max-width:70%; padding:10px 14px;border-radius:16px;line-height:1.45; animation:fadeIn .25s ease; box-shadow:0 0 10px rgba(0,0,0,.3);
  font-size:.94rem; transition:transform .2s ease, box-shadow .2s ease; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere;}
.user-bubble{background:linear-gradient(145deg,var(--accent),var(--accent-2)); align-self:flex-end;color:#fff;}
.bot-bubble{background:linear-gradient(145deg,var(--green),var(--green-2)); align-self:flex-start;color:#fff;display:inline-flex;align-items:center;gap:8px;vertical-align:middle;}
.chat-bubble:hover,.chat-bubble:active{transform:translateY(-4px) scale(1.02);box-shadow:0 0 15px rgba(0,0,0,.4)}
.bot-icon{display:inline-flex;align-items:center;justify-content:center;width:1.05rem;height:1.05rem;font-size:1rem;line-height:1;vertical-align:middle;transform:translateY(1px)}
.bot-icon.spin{animation:botSpin 2s linear infinite}
@keyframes botSpin{100%{transform:translateY(1px) rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.input-bar{position:sticky;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--line);
  padding:12px;display:flex;align-items:center;gap:10px;z-index:180;}
.input{flex:1;background:#fff;color:#000;font-weight:600; padding:12px 18px;border-radius:40px;outline:none;border:1px solid #1a1a1a;
  font-size:.95rem;resize:none;min-height:44px;}
.input::placeholder{color:#555;font-weight:500}
.attach-pop{position:fixed;right:96px; bottom:calc(var(--barH) + 24px); background:var(--panel); border:1px solid var(--line);border-radius:12px;padding:8px;width:180px;
  display:none;flex-direction:column;animation:pop .2s ease-out forwards;z-index:181;}
.attach-pop button{background:transparent;border:none;color:#fff;text-align:left;padding:10px;border-radius:8px;cursor:pointer}
.attach-pop button:hover{background:var(--panel-2)}
@keyframes pop{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.dots{display:inline-block;width:28px;text-align:left}
.dots span{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#fff;opacity:.6;animation:float 1.2s infinite ease-in-out}
.dots span:nth-child(1){animation-delay:0s}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.3s}
@keyframes float{0%,80%,100%{transform:translateY(0);opacity:.5}40%{transform:translateY(-6px);opacity:1}}
.spinnerX{display:inline-block;margin-left:6px;font-weight:700;color:#fff;animation:spin 1s linear infinite;transform-origin:center}
@keyframes spin{100%{transform:rotate(360deg)}}
.fade-out{animation:fadeShrink .22s ease forwards}
@keyframes fadeShrink{to{opacity:0; transform:translateY(-4px) scale(.95)}}
@media(max-width:680px){ .chat-bubble{max-width:85%} }
</style>
</head>
<body>
<header>
  <div class="left">
    <button class="menu-btn" id="menuToggle" aria-label="Open menu">&#9776;</button>
    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="Robot">
    <h1>Prototype-X</h1>
  </div>
  <div class="actions">
    <button class="icon-btn" id="memoryBtn" title="Show Memory">üß†</button>
    <button class="icon-btn" id="newChatBtn" title="New Chat">üóëÔ∏è</button>
  </div>
</header>

<aside class="sidebar" id="sidebar" aria-hidden="true">
  <div class="sb-top">
    <div class="sb-title"><span class="gear">‚öôÔ∏è</span> <span>Controls</span></div>
    <button class="close-btn" id="closeSidebar" aria-label="Close">√ó</button>
  </div>
  <div class="sb-body">
    <div class="group">
      <div class="label">Answer Mode</div>
      <select class="select" id="answerMode">
        <option selected>Chat (Groq AI)</option><option>Ask (Groq AI)</option><option>RAG Search</option>
      </select>
    </div>
    <div class="check"><input type="checkbox" id="hinglish" checked><label for="hinglish">Hinglish replies</label></div>
    <div class="group">
      <div class="label">Max lines per answer</div>
      <div class="slider-row">
        <input class="slider" type="range" id="maxLines" min="3" max="12" value="7">
        <span class="badge" id="maxLinesVal">7</span>
      </div>
    </div>
    <div class="group">
      <div class="label">Groq model</div>
      <select class="select" id="groqModel">
        <option>llama-3.1-70b</option>
        <option selected>llama-3.1-8b-instant</option>
        <option>mixtral-8x7b</option>
      </select>
    </div>
    <div class="group">
      <div class="label">Docs confidence</div>
      <div class="slider-row">
        <span class="badge">0.32</span>
        <input class="slider" type="range" id="docsConf" min="0.32" max="0.85" step="0.01" value="0.55">
        <span class="badge">0.85</span>
        <span class="badge" id="docsConfVal">0.55</span>
      </div>
      <span class="hint">How strictly to trust doc chunks</span>
    </div>
    <div class="check"><input type="checkbox" id="autosend" checked><label for="autosend">Auto-send on Stop</label></div>
    <div class="credits">Made with ‚ù§Ô∏è ‚Äî Team Prototype-X</div>
  </div>
</aside>
<div class="backdrop" id="backdrop"></div>

<main class="main">
  <section class="chat-container" id="chatContainer" aria-live="polite">
    <div class="chat-bubble bot-bubble" id="introBubble">
      <span class="bot-icon" data-static="true">ü§ñ</span>
      <span>Namaste! Main Prototype-X hoon. Aaj main aapki kaise help kar sakta hoon?</span>
    </div>
  </section>

  <div class="input-bar" id="inputBar">
    <textarea id="userInput" class="input" placeholder="Ask me anything..."></textarea>
    <button class="icon-btn" id="attachBtn" title="Attach">üìé</button>
    <button class="icon-btn" id="micBtn" title="Speak">üé§</button>
    <button class="icon-btn" id="sendBtn" title="Send">‚û§</button>
    <div class="attach-pop" id="attachPop">
      <button id="summarizeBtn">üß© Summarize</button>
      <button id="uploadBtn">üì§ Upload File</button>
      <input id="hiddenFile" type="file" style="display:none"/>
    </div>
  </div>
</main>

<script>
// ===== Session ID =====
const SESSION_KEY = "px_session_id";
let sessionId = localStorage.getItem(SESSION_KEY);
if(!sessionId){
  sessionId = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
  localStorage.setItem(SESSION_KEY, sessionId);
}

// ===== Sidebar =====
const sidebar=document.getElementById('sidebar');
const menuToggle=document.getElementById('menuToggle');
const closeSidebar=document.getElementById('closeSidebar');
const backdrop=document.getElementById('backdrop');
menuToggle.onclick=()=>{sidebar.classList.add('active');backdrop.classList.add('show');};
closeSidebar.onclick=()=>{sidebar.classList.remove('active');backdrop.classList.remove('show');};
backdrop.onclick=()=>{sidebar.classList.remove('active');backdrop.classList.remove('show');};

const maxLines=document.getElementById('maxLines');
const maxLinesVal=document.getElementById('maxLinesVal');
const docsConf=document.getElementById('docsConf');
const docsConfVal=document.getElementById('docsConfVal');
maxLines?.addEventListener('input',()=> maxLinesVal.textContent=maxLines.value);
docsConf?.addEventListener('input',()=> docsConfVal.textContent=Number(docsConf.value).toFixed(2));

// ===== Chat UI helpers =====
const chat = document.getElementById('chatContainer');
const inputBar = document.getElementById('inputBar');
const input = document.getElementById('userInput');
const send  = document.getElementById('sendBtn');

function setBarHeight(){
  const h = (inputBar?.offsetHeight || 88);
  document.documentElement.style.setProperty('--barH', h + 'px');
}
function scrollToBottom(){
  const last = chat.lastElementChild;
  if(last){ last.scrollIntoView({behavior:'smooth', block:'end'}); }
  requestAnimationFrame(()=> window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'}));
}
function keepBottom(){ setBarHeight(); scrollToBottom(); }
setBarHeight(); window.addEventListener('resize', setBarHeight);
if (window.visualViewport){ visualViewport.addEventListener('resize', setBarHeight); }
new MutationObserver(scrollToBottom).observe(chat, {childList:true});

function showProcessing(){
  const b=document.createElement('div');
  b.className='chat-bubble bot-bubble';
  b.innerHTML=`<span class="bot-icon spin">ü§ñ</span>
               <span>Soch raha hoon&nbsp;</span>
               <span class="dots"><span></span><span></span><span></span></span>`;
  chat.appendChild(b); keepBottom(); return b;
}
function addBotAnswer(text){
  const bot=document.createElement('div');
  bot.className='chat-bubble bot-bubble';
  bot.innerHTML = `<span class="bot-icon">ü§ñ</span><span>${text}</span>`;
  chat.appendChild(bot); keepBottom();
}

// ===== Send message =====
async function sendMsg(){
  const msg = input.value.trim(); if(!msg) return;
  input.value='';
  const u=document.createElement('div');
  u.className='chat-bubble user-bubble'; u.textContent=msg;
  chat.appendChild(u); keepBottom();

  const thinkingNode = showProcessing();
  try{
    const res = await fetch("http://127.0.0.1:5000/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        query: msg,
        session_id: sessionId,
        mode: document.getElementById("answerMode").value,
        hinglish: document.getElementById("hinglish").checked,
        max_lines: parseInt(document.getElementById("maxLines").value,10),
        docs_conf: Number(document.getElementById("docsConf").value),
        model: document.getElementById("groqModel").value
      })
    });
    const data = await res.json();
    thinkingNode.remove();
    addBotAnswer(data.answer || data.error || "No reply.");
    if (data.session_id) sessionId = data.session_id;
  }catch(err){
    thinkingNode.remove();
    addBotAnswer("‚ö†Ô∏è Connection error: " + err.message);
  }
}
send.onclick=sendMsg;
input.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); } });

// ===== Memory (debug) =====
document.getElementById('memoryBtn').onclick = async ()=>{
  try{
    const r = await fetch(`http://127.0.0.1:5000/memory?session_id=${sessionId}`);
    const d = await r.json();
    alert("Facts I remember:\n" + JSON.stringify(d.facts, null, 2));
  }catch{}
};

// ===== New Chat (reset) =====
document.getElementById('newChatBtn').onclick = async ()=>{
  chat.innerHTML = `
    <div class="chat-bubble bot-bubble" id="introBubble">
      <span class="bot-icon" data-static="true">ü§ñ</span>
      <span>Namaste! Main Prototype-X hoon. Aaj main aapki kaise help kar sakta hoon?</span>
    </div>`;
  try{
    await fetch("http://127.0.0.1:5000/reset_memory", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ session_id: sessionId })
    });
  }catch{}
};
</script>
</body>
</html>